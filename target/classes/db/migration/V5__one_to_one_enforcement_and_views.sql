-- 2) View: beacons pareados a motos
CREATE OR REPLACE VIEW VW_BEACONS_PAREADOS AS
SELECT b.ID_BEACON, b.UUID, b.BATERIA, m.ID_MOTO, m.PLACA, b.ID_MODELO_BEACON
FROM TB_BEACON b
         JOIN TB_MOTO   m ON m.ID_MOTO = b.ID_MOTO;

-- 3) View: beacons disponíveis (sem moto)
CREATE OR REPLACE VIEW VW_BEACONS_DISPONIVEIS AS
SELECT b.ID_BEACON, b.UUID, b.BATERIA, b.ID_MODELO_BEACON
FROM TB_BEACON b
WHERE b.ID_MOTO IS NULL;

-- 4) View: última localização por moto
CREATE OR REPLACE VIEW VW_MOTOS_ULTIMA_LOCALIZACAO AS
SELECT x.ID_MOTO, x.PLACA, x.POSICAO_X, x.POSICAO_Y, x.DATA_HORA, x.PATIO
FROM (
         SELECT m.ID_MOTO, m.PLACA, l.POSICAO_X, l.POSICAO_Y, l.DATA_HORA,
                p.NOME AS PATIO,
                ROW_NUMBER() OVER (PARTITION BY m.ID_MOTO ORDER BY l.DATA_HORA DESC) RN
         FROM TB_MOTO m
                  LEFT JOIN TB_LOCALIZACAO l ON l.ID_MOTO = m.ID_MOTO
                  LEFT JOIN TB_PATIO        p ON p.ID_PATIO = l.ID_PATIO
     ) x
WHERE x.RN = 1;
