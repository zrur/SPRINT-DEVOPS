-- ===================================================
-- CONSTRAINTS, INDEXES, SEQUENCES & TRIGGERS de PK
-- (Oracle) – auto numeração e relacionamentos
-- ===================================================

-- ===== FKs =====
ALTER TABLE TB_ESTADO ADD CONSTRAINT FK_ESTADO_PAIS
    FOREIGN KEY (ID_PAIS) REFERENCES TB_PAIS(ID_PAIS);

ALTER TABLE TB_CIDADE ADD CONSTRAINT FK_CIDADE_ESTADO
    FOREIGN KEY (ID_ESTADO) REFERENCES TB_ESTADO(ID_ESTADO);

ALTER TABLE TB_MOTO ADD CONSTRAINT FK_MOTO_CLIENTE
    FOREIGN KEY (ID_CLIENTE) REFERENCES TB_CLIENTE(ID_CLIENTE);

ALTER TABLE TB_MOTO ADD CONSTRAINT FK_MOTO_MODELO
    FOREIGN KEY (ID_MODELO_MOTO) REFERENCES TB_MODELO_MOTO(ID_MODELO_MOTO);

ALTER TABLE TB_BEACON ADD CONSTRAINT FK_BEACON_MOTO
    FOREIGN KEY (ID_MOTO) REFERENCES TB_MOTO(ID_MOTO);

ALTER TABLE TB_BEACON ADD CONSTRAINT FK_BEACON_MODELO
    FOREIGN KEY (ID_MODELO_BEACON) REFERENCES TB_MODELO_BEACON(ID_MODELO_BEACON);

ALTER TABLE TB_MOVIMENTACAO ADD CONSTRAINT FK_MOV_MOTO
    FOREIGN KEY (ID_MOTO) REFERENCES TB_MOTO(ID_MOTO);

ALTER TABLE TB_MOVIMENTACAO ADD CONSTRAINT FK_MOV_TIPO
    FOREIGN KEY (ID_TIPO_MOVIMENTACAO) REFERENCES TB_TIPO_MOVIMENTACAO(ID_TIPO_MOVIMENTACAO);

ALTER TABLE TB_LOCALIZACAO ADD CONSTRAINT FK_LOC_MOTO
    FOREIGN KEY (ID_MOTO) REFERENCES TB_MOTO(ID_MOTO);

ALTER TABLE TB_LOCALIZACAO ADD CONSTRAINT FK_LOC_PATIO
    FOREIGN KEY (ID_PATIO) REFERENCES TB_PATIO(ID_PATIO);

ALTER TABLE TB_REGISTRO_BATERIA ADD CONSTRAINT FK_REG_BAT_BEACON
    FOREIGN KEY (ID_BEACON) REFERENCES TB_BEACON(ID_BEACON);

ALTER TABLE TB_USUARIO ADD CONSTRAINT FK_USUARIO_TIPO
    FOREIGN KEY (ID_TIPO_USUARIO) REFERENCES TB_TIPO_USUARIO(ID_TIPO_USUARIO);

-- ===== UNIQUE / CHECK =====
-- Placa e UUID já únicas:
CREATE UNIQUE INDEX UX_MOTO_PLACA ON TB_MOTO(PLACA);
CREATE UNIQUE INDEX UX_BEACON_UUID ON TB_BEACON(UUID);

-- *** Importante: garante 1–1 (um beacon por moto) ***
ALTER TABLE TB_BEACON ADD CONSTRAINT UQ_BEACON_MOTO UNIQUE (ID_MOTO);

-- (Opcional) Validação do nível de bateria
ALTER TABLE TB_BEACON ADD CONSTRAINT CHK_BEACON_BATERIA CHECK (BATERIA BETWEEN 0 AND 100);

-- ===== INDEXES auxiliares =====
CREATE INDEX IX_MOV_MOTO ON TB_MOVIMENTACAO(ID_MOTO);
CREATE INDEX IX_LOC_MOTO ON TB_LOCALIZACAO(ID_MOTO);
CREATE INDEX IX_BEACON_MODELO ON TB_BEACON(ID_MODELO_BEACON);
CREATE INDEX IX_MOTO_MODELO ON TB_MOTO(ID_MODELO_MOTO);

-- ===== SEQUENCES & TRIGGERS de PK =====
-- (padrão: SEQ_<tabela> + TRG_<tabela>_ID)

-- País
CREATE SEQUENCE SEQ_PAIS START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_PAIS_ID
BEFORE INSERT ON TB_PAIS FOR EACH ROW
BEGIN
  IF :NEW.ID_PAIS IS NULL THEN
SELECT SEQ_PAIS.NEXTVAL INTO :NEW.ID_PAIS FROM DUAL;
END IF;
END;
/

-- Estado
CREATE SEQUENCE SEQ_ESTADO START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_ESTADO_ID
BEFORE INSERT ON TB_ESTADO FOR EACH ROW
BEGIN
  IF :NEW.ID_ESTADO IS NULL THEN
SELECT SEQ_ESTADO.NEXTVAL INTO :NEW.ID_ESTADO FROM DUAL;
END IF;
END;
/

-- Cidade
CREATE SEQUENCE SEQ_CIDADE START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_CIDADE_ID
BEFORE INSERT ON TB_CIDADE FOR EACH ROW
BEGIN
  IF :NEW.ID_CIDADE IS NULL THEN
SELECT SEQ_CIDADE.NEXTVAL INTO :NEW.ID_CIDADE FROM DUAL;
END IF;
END;
/

-- Cliente
CREATE SEQUENCE SEQ_CLIENTE START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_CLIENTE_ID
BEFORE INSERT ON TB_CLIENTE FOR EACH ROW
BEGIN
  IF :NEW.ID_CLIENTE IS NULL THEN
SELECT SEQ_CLIENTE.NEXTVAL INTO :NEW.ID_CLIENTE FROM DUAL;
END IF;
END;
/

-- Modelo Moto
CREATE SEQUENCE SEQ_MODELO_MOTO START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_MODELO_MOTO_ID
BEFORE INSERT ON TB_MODELO_MOTO FOR EACH ROW
BEGIN
  IF :NEW.ID_MODELO_MOTO IS NULL THEN
SELECT SEQ_MODELO_MOTO.NEXTVAL INTO :NEW.ID_MODELO_MOTO FROM DUAL;
END IF;
END;
/

-- Modelo Beacon
CREATE SEQUENCE SEQ_MODELO_BEACON START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_MODELO_BEACON_ID
BEFORE INSERT ON TB_MODELO_BEACON FOR EACH ROW
BEGIN
  IF :NEW.ID_MODELO_BEACON IS NULL THEN
SELECT SEQ_MODELO_BEACON.NEXTVAL INTO :NEW.ID_MODELO_BEACON FROM DUAL;
END IF;
END;
/

-- Moto
CREATE SEQUENCE SEQ_MOTO START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_MOTO_ID
BEFORE INSERT ON TB_MOTO FOR EACH ROW
BEGIN
  IF :NEW.ID_MOTO IS NULL THEN
SELECT SEQ_MOTO.NEXTVAL INTO :NEW.ID_MOTO FROM DUAL;
END IF;
END;
/

-- Beacon
CREATE SEQUENCE SEQ_BEACON START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_BEACON_ID
BEFORE INSERT ON TB_BEACON FOR EACH ROW
BEGIN
  IF :NEW.ID_BEACON IS NULL THEN
SELECT SEQ_BEACON.NEXTVAL INTO :NEW.ID_BEACON FROM DUAL;
END IF;
END;
/

-- Pátio
CREATE SEQUENCE SEQ_PATIO START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_PATIO_ID
BEFORE INSERT ON TB_PATIO FOR EACH ROW
BEGIN
  IF :NEW.ID_PATIO IS NULL THEN
SELECT SEQ_PATIO.NEXTVAL INTO :NEW.ID_PATIO FROM DUAL;
END IF;
END;
/

-- Tipo Movimentação
CREATE SEQUENCE SEQ_TIPO_MOV START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_TIPO_MOV_ID
BEFORE INSERT ON TB_TIPO_MOVIMENTACAO FOR EACH ROW
BEGIN
  IF :NEW.ID_TIPO_MOVIMENTACAO IS NULL THEN
SELECT SEQ_TIPO_MOV.NEXTVAL INTO :NEW.ID_TIPO_MOVIMENTACAO FROM DUAL;
END IF;
END;
/

-- Movimentação
CREATE SEQUENCE SEQ_MOVIMENTACAO START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_MOVIMENTACAO_ID
BEFORE INSERT ON TB_MOVIMENTACAO FOR EACH ROW
BEGIN
  IF :NEW.ID_MOVIMENTACAO IS NULL THEN
SELECT SEQ_MOVIMENTACAO.NEXTVAL INTO :NEW.ID_MOVIMENTACAO FROM DUAL;
END IF;
END;
/

-- Localização
CREATE SEQUENCE SEQ_LOCALIZACAO START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_LOCALIZACAO_ID
BEFORE INSERT ON TB_LOCALIZACAO FOR EACH ROW
BEGIN
  IF :NEW.ID_LOCALIZACAO IS NULL THEN
SELECT SEQ_LOCALIZACAO.NEXTVAL INTO :NEW.ID_LOCALIZACAO FROM DUAL;
END IF;
END;
/

-- Log
CREATE SEQUENCE SEQ_LOG START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_LOG_ID
BEFORE INSERT ON TB_LOG_SISTEMA FOR EACH ROW
BEGIN
  IF :NEW.ID_LOG IS NULL THEN
SELECT SEQ_LOG.NEXTVAL INTO :NEW.ID_LOG FROM DUAL;
END IF;
END;
/

-- Registro Bateria
CREATE SEQUENCE SEQ_REG_BATERIA START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_REG_BATERIA_ID
BEFORE INSERT ON TB_REGISTRO_BATERIA FOR EACH ROW
BEGIN
  IF :NEW.ID_REGISTRO_BATERIA IS NULL THEN
SELECT SEQ_REG_BATERIA.NEXTVAL INTO :NEW.ID_REGISTRO_BATERIA FROM DUAL;
END IF;
END;
/

-- Segurança
CREATE SEQUENCE SEQ_TIPO_USUARIO START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_TIPO_USUARIO_ID
BEFORE INSERT ON TB_TIPO_USUARIO FOR EACH ROW
BEGIN
  IF :NEW.ID_TIPO_USUARIO IS NULL THEN
SELECT SEQ_TIPO_USUARIO.NEXTVAL INTO :NEW.ID_TIPO_USUARIO FROM DUAL;
END IF;
END;
/

CREATE SEQUENCE SEQ_USUARIO START WITH 100 INCREMENT BY 1;
CREATE OR REPLACE TRIGGER TRG_USUARIO_ID
BEFORE INSERT ON TB_USUARIO FOR EACH ROW
BEGIN
  IF :NEW.ID_USUARIO IS NULL THEN
SELECT SEQ_USUARIO.NEXTVAL INTO :NEW.ID_USUARIO FROM DUAL;
END IF;
END;
/
