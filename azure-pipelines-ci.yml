# Azure DevOps - Pipeline CI
# Build + Testes + Docker Build + Push para ACR

trigger:
  branches:
    include:
      - sprint-4-devops

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: 'mottooth-variables'
  - name: acrLoginServer
    value: 'acrmottooth.azurecr.io'  # ✅ CORRIGIDO
  - name: imageName
    value: 'mottooth-app-devops'     # ✅ CORRIGIDO
  - name: imageTag
    value: '$(Build.BuildId)'

stages:
  - stage: Build
    displayName: 'Build, Testes e Docker'
    jobs:
      - job: BuildJob
        displayName: 'Build e Deploy Docker'
        steps:
          # 1. Checkout
          - checkout: self
            displayName: 'Checkout código'

          # 2. Setup Java
          - task: JavaToolInstaller@0
            displayName: 'Instalar Java 21'
            inputs:
              versionSpec: '21'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # 3. Build Maven
          - task: Maven@3
            displayName: 'Maven Clean Package'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean package'
              options: '-DskipTests=false'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.21'

          # 4. Executar Testes
          - task: Maven@3
            displayName: 'Executar Testes'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'test'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.21'

          # 5. Publicar Testes
          - task: PublishTestResults@2
            displayName: 'Publicar Resultados Testes'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              failTaskOnFailedTests: true

          # 6. Publicar JAR
          - task: PublishBuildArtifacts@1
            displayName: 'Publicar JAR'
            inputs:
              PathtoPublish: 'target/mottooth-0.0.1-SNAPSHOT.jar'
              ArtifactName: 'mottooth-jar'

          # 7. Build Docker Image
          - task: Docker@2
            displayName: 'Build Docker Image'
            inputs:
              command: 'build'
              repository: '$(acrLoginServer)/$(imageName)'
              dockerfile: 'Dockerfile'
              tags: |
                $(imageTag)
                latest

          # 8. Login no ACR
          - task: Docker@2
            displayName: 'Login ACR'
            inputs:
              command: 'login'
              containerRegistry: 'acrmottooth-connection'  # ✅ Nome da Service Connection

          # 9. Push para ACR
          - task: Docker@2
            displayName: 'Push Docker para ACR'
            inputs:
              command: 'push'
              containerRegistry: 'acrmottooth-connection'  # ✅ Nome da Service Connection
              repository: '$(imageName)'
              tags: |
                $(imageTag)
                latest

          # 10. Salvar image tag
          - bash: |
              echo "$(acrLoginServer)/$(imageName):latest" > image-tag.txt
              cat image-tag.txt
            displayName: 'Gerar Image Tag'

          - task: PublishBuildArtifacts@1
            displayName: 'Publicar Image Tag'
            inputs:
              PathtoPublish: 'image-tag.txt'
              ArtifactName: 'image-info'